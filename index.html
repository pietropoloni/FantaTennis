<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FantaTennis App</title>
  <meta name="description" content="Pick your fantasy tennis squad from the ATP Top 100." />
  <meta name="theme-color" content="#0f172a" />
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="FantaTennis" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.json" />
  <!-- iPhone icon -->
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon1-180.png" />
  <style>
    :root{
      --bg:#0b1020; --card:#111834; --text:#e5e7eb; --muted:#9aa4b2;
      --a:#ef4444; --b:#3b82f6; --c:#10b981; --d:#f59e0b;
      --ok:#22c55e; --ring:#334155; --accent:#7dd3fc;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0f1f 0%, #0f1731 100%);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,16,32,0.85);backdrop-filter:blur(10px);border-bottom:1px solid #1f2a44;z-index:20}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
    .topbar{display:flex;align-items:center;gap:10px}
    .brand{font-weight:800;letter-spacing:.6px}
    .spacer{flex:1}
    button{
      background:#1b2344;color:#e5e7eb;border:1px solid #2a3665;border-radius:12px;
      padding:9px 12px;font-weight:600;cursor:pointer;transition:.2s;box-shadow:0 1px 0 #000 inset
    }
    button:hover{transform:translateY(-1px);background:#1f2a55}
    button:disabled{opacity:.55;cursor:not-allowed}
    select, input[type="text"], input[type="number"], input[type="date"], textarea{
      padding:8px 10px;border-radius:8px;background:#1b2344;color:#e5e7eb;border:1px solid #2a3665
    }
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--ring);border-radius:999px;background:#0c132b}
    .dot{width:10px;height:10px;border-radius:999px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin:16px 0 28px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .card{
      background:var(--card);border:1px solid #1d2748;border-radius:16px;padding:12px 12px;
      display:flex;align-items:center;gap:12px;min-height:64px;transition:border-color .2s, transform .05s
    }
    .card:hover{border-color:#2a3a6a}
    .rank{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:#0c132b;border:1px solid #26325a;color:#cbd5e1;font-weight:700}
    .name{font-weight:700;letter-spacing:.2px}
    .meta{color:var(--muted);font-size:.85rem;margin-top:2px}
    .tag{margin-left:auto;font-weight:800;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;color:#0b1020}
    .tag.A{background:var(--a)} .tag.B{background:var(--b)} .tag.C{background:var(--c)} .tag.D{background:var(--d)}
    .card.sel{outline:2px solid var(--accent); outline-offset:2px; transform:translateY(-1px)}
    .toast{position:fixed;right:14px;bottom:14px;background:#111834;border:1px solid #2a3665;padding:12px 14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.25);z-index:100;max-width:90vw}
    .hide{display:none}
    .footer{color:var(--muted);font-size:.85rem;margin:20px 0 40px}
    .legend{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .bandCount{font-weight:700}
    code.kbd{background:#0c132b;padding:2px 6px;border:1px solid #26325a;border-radius:6px}

    /* Drawer (burger menu) */
    .drawer{position:fixed;inset:0;pointer-events:none;z-index:90}
    .drawer .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35);opacity:0;transition:opacity .2s ease;z-index:1}
    .drawer .panel{
      position:absolute;left:0;top:0;height:100%;width:260px;background:#0b1020;border-right:1px solid #1d2748;
      transform:translateX(-100%);transition:transform .2s ease;box-shadow:8px 0 30px rgba(0,0,0,.35);padding:16px;z-index:2
    }
    .drawer.open{pointer-events:auto}
    .drawer.open .panel{transform:translateX(0)}
    .drawer.open .backdrop{opacity:1}

    /* Sections are hidden until chosen from the menu */
    .section{display:none}
    .section.active{display:block}

    /* HOME (only visible when active) */
    #view-home{
      position:relative;min-height:calc(100vh - 72px);
      background:linear-gradient(180deg, #0f3aad 0%, #1e40af 100%);
      border-radius:20px;margin-top:12px
    }
    /* home layout when active */
    #view-home.section.active{ display:grid; place-items:center; }
    .hero-text{text-align:center;line-height:0.9;font-weight:900;letter-spacing:1px;font-size:clamp(56px, 16vw, 160px);color:#eaf2ff;text-shadow:0 6px 24px rgba(0,0,0,.35)}
    .hero-text span{display:block}
    .hero-sub{margin-top:12px;color:#dbeafe;font-weight:600;letter-spacing:.5px;text-align:center}

    /* Tables */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #223055;padding:8px 10px;text-align:left}
    .table th{color:#cbd5e1;font-weight:700}

    /* Mobile tweaks */
    @media (max-width:720px){
      .wrap{padding:12px}
      .grid{grid-template-columns:1fr}
      .brand{font-size:1.1rem}
    }
  </style>
</head>
<body>
  <!-- Drawer (backdrop FIRST, then panel) -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="backdrop" id="drawerBackdrop" tabindex="-1" aria-hidden="true"></div>
    <div class="panel" role="menu" aria-label="Main menu">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:800">Menu</div>
        <button id="closeDrawer" aria-label="Close menu">‚úï</button>
      </div>
      <div class="row" style="flex-direction:column;align-items:stretch;gap:8px">
        <button class="navbtn" data-view="home">üè† Home</button>
        <button class="navbtn" data-view="myteam">üéæ My Team</button>
        <button class="navbtn" data-view="teams">üë• Teams</button>
        <button class="navbtn" data-view="leagues">üèÜ Leagues</button>
        <button class="navbtn" data-view="stats">üìà Statistics</button>
        <button class="navbtn" id="checkUpdateBtn">‚Üª Check updates</button>
      </div>
    </div>
  </aside>

  <header>
    <div class="wrap">
      <div class="topbar">
        <!-- Burger on top-left -->
        <button id="openDrawer" aria-label="Open menu">‚ò∞</button>
        <div class="brand">FantaTennis</div>
        <div class="spacer"></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="view-home" class="section active" aria-label="Home">
      <div>
        <div class="hero-text">
          <span>FANTA</span>
          <span>TENNIS</span>
        </div>
        <div class="hero-sub">Open the menu ‚ò∞ to get started</div>
      </div>
    </section>

    <!-- MY TEAM -->
    <section id="view-myteam" class="section" aria-label="My Team">
      <h2>My Team</h2>

      <div class="sub">Pick up to <b>3 players per band</b> from the official ATP Top 100 (static list as of Aug 25, 2025).
        <span class="legend" style="display:block;margin-top:8px">
          <span class="pill"><span class="dot" style="background:var(--a)"></span> A (1‚Äì10) <span id="cntA" class="bandCount">0/3</span></span>
          <span class="pill"><span class="dot" style="background:var(--b)"></span> B (11‚Äì30) <span id="cntB" class="bandCount">0/3</span></span>
          <span class="pill"><span class="dot" style="background:var(--c)"></span> C (31‚Äì50) <span id="cntC" class="bandCount">0/3</span></span>
          <span class="pill"><span class="dot" style="background:var(--d)"></span> D (51‚Äì100) <span id="cntD" class="bandCount">0/3</span></span>
        </span>
      </div>

      <!-- Controls -->
      <div class="row" style="margin-top:10px">
        <button id="clearBtn">‚úï Clear selections</button>
        <button id="copyBtn">‚ßâ Copy picks</button>

        <span class="row" style="margin-left:auto">
          <input id="teamName" type="text" placeholder="Your team name" style="min-width:220px" />
          <button id="saveTeamBtn">üíæ Save team</button>
        </span>
      </div>

      <div class="row" style="margin-top:8px">
        <label>
          Filter band:
          <select id="bandFilter">
            <option value="all">All</option>
            <option value="A">Band A (1‚Äì10)</option>
            <option value="B">Band B (11‚Äì30)</option>
            <option value="C">Band C (31‚Äì50)</option>
            <option value="D">Band D (51‚Äì100)</option>
          </select>
        </label>
        <div class="pill">Budget left: <span id="budget" style="margin-left:6px;font-weight:700">900M</span></div>
        <button id="adminBtn" class="row">üîí Admin mode</button>
      </div>

      <h3 style="margin:16px 0 6px">My Picks</h3>
      <div id="selected" class="grid" aria-live="polite"></div>

      <div id="status" class="sub" role="status" aria-live="polite"></div>
      <div id="grid" class="grid" aria-live="polite" aria-busy="true"></div>

      <div class="footer">
        <p>Source: ATP Tour ‚Äî Singles Rankings (numerical PDF). Snapshot date: <b>Aug 25, 2025</b>.</p>
        <p class="sub">Bands are non-overlapping: A (1‚Äì10), B (11‚Äì30), C (31‚Äì50), D (51‚Äì100). Selections are stored locally and work offline.</p>
      </div>
    </section>

    <!-- TEAMS -->
    <section id="view-teams" class="section" aria-label="Teams">
      <h2>Teams</h2>
      <div class="row" style="margin-bottom:8px">
        <button id="exportTeamsBtn">‚§¥ Export teams (JSON)</button>
        <button id="importTeamsBtn">‚§µ Import teams</button>
      </div>
      <div id="teamsList"></div>
      <div id="importArea" class="hide" style="margin-top:12px">
        <p class="sub">Paste teams JSON below and click <b>Import</b>. Existing team names are kept (duplicates are skipped).</p>
        <textarea id="importTextarea" placeholder='{"teams":{...}}'></textarea>
        <div class="row" style="margin-top:8px">
          <button id="confirmImportBtn">Import</button>
          <button id="cancelImportBtn">Cancel</button>
        </div>
      </div>
    </section>

    <!-- LEAGUES -->
    <section id="view-leagues" class="section" aria-label="Leagues">
      <h2>Leagues</h2>
      <div class="row" style="gap:12px;margin-bottom:10px">
        <fieldset class="row" style="gap:8px">
          <legend class="sub">Join league (invite code)</legend>
          <input id="joinCode" type="text" placeholder="Invite code" style="width:140px" />
          <button id="joinLeagueBtn">Join with my team</button>
        </fieldset>
        <fieldset class="row" style="gap:8px">
          <legend class="sub">Create league (admin)</legend>
          <input id="leagueName" type="text" placeholder="League name" style="min-width:200px" />
          <button id="createLeagueBtn">‚ûï Create</button>
        </fieldset>
      </div>

      <div id="leaguesList"></div>
    </section>

    <!-- STATS -->
    <section id="view-stats" class="section" aria-label="Statistics">
      <h2>Leaderboard (Total Points)</h2>
      <table class="table" id="leaderboard">
        <thead><tr><th>#</th><th>Team</th><th>Total Points</th><th>Budget Spent</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast hide" role="alert"></div>

  <!-- Update / SW bootstrap -->
  <script>
    const APP_VERSION = '2025.08.29.viewfix-v1'; // bump on each deploy

    async function hardUpdate(reason='manual'){
      try{
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
        if ('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        localStorage.setItem('ft.appVersion', APP_VERSION);
      }catch(e){ console.error(e); }
      setTimeout(()=> location.reload(), 300);
    }

    (function bootstrapUpdates(){
      const prev = localStorage.getItem('ft.appVersion');
      if (prev !== APP_VERSION){
        hardUpdate('version change');
        return;
      }
      if ('serviceWorker' in navigator){
        window.addEventListener('load', async () => {
          try{
            const reg = await navigator.serviceWorker.register(`./service-worker.js?v=${encodeURIComponent(APP_VERSION)}`);
            setInterval(()=> reg.update().catch(()=>{}), 60*60*1000);
          }catch(e){ console.warn('SW registration failed', e); }
        });
      }
    })();
  </script>

  <script>
    // ===== CONFIG =====
    const ADMIN_PIN = '123456'; // change for deployment
    const STORAGE_KEY_PICKS = 'ft.picks.v1';
    const STORAGE_KEY_TEAMS = 'ft.teams.v1';
    const STORAGE_KEY_LEAGUES = 'ft.leagues.v1';
    const STORAGE_KEY_ADMIN = 'ft.admin.v1';
    const STORAGE_KEY_MYNAME = 'ft.myTeamName.v1';

    const MAX_PER_BAND = 3;
    const MAX_BUDGET = 900_000_000; // 900M total budget

    // ---- Static Top 100 ----
    const PLAYERS = [
      {rank:1, name:"Jannik Sinner"},{rank:2, name:"Carlos Alcaraz"},{rank:3, name:"Alexander Zverev"},
      {rank:4, name:"Taylor Fritz"},{rank:5, name:"Jack Draper"},{rank:6, name:"Ben Shelton"},
      {rank:7, name:"Novak Djokovic"},{rank:8, name:"Alex de Minaur"},{rank:9, name:"Karen Khachanov"},
      {rank:10, name:"Lorenzo Musetti"},{rank:11, name:"Holger Rune"},{rank:12, name:"Casper Ruud"},
      {rank:13, name:"Daniil Medvedev"},{rank:14, name:"Tommy Paul"},{rank:15, name:"Andrey Rublev"},
      {rank:16, name:"Jakub Mensik"},{rank:17, name:"Frances Tiafoe"},{rank:18, name:"Alejandro Davidovich Fokina"},
      {rank:19, name:"Francisco Cerundolo"},{rank:20, name:"Arthur Fils"},{rank:21, name:"Jiri Lehecka"},
      {rank:22, name:"Tomas Machac"},{rank:23, name:"Ugo Humbert"},{rank:24, name:"Alexander Bublik"},
      {rank:25, name:"Grigor Dimitrov"},{rank:26, name:"Flavio Cobolli"},{rank:27, name:"Felix Auger-Aliassime"},
      {rank:28, name:"Stefanos Tsitsipas"},{rank:29, name:"Denis Shapovalov"},{rank:30, name:"Tallon Griekspoor"},
      {rank:31, name:"Brandon Nakashima"},{rank:32, name:"Alex Michelsen"},{rank:33, name:"Gabriel Diallo"},
      {rank:34, name:"Luciano Darderi"},{rank:35, name:"Cameron Norrie"},{rank:36, name:"Alexei Popyrin"},
      {rank:37, name:"Giovanni Mpetshi Perricard"},{rank:38, name:"Alexandre Muller"},{rank:39, name:"Sebastian Baez"},
      {rank:40, name:"Corentin Moutet"},{rank:41, name:"Nuno Borges"},{rank:42, name:"Miomir Kecmanovic"},
      {rank:43, name:"Camilo Ugo Carabelli"},{rank:44, name:"Jaume Munar"},{rank:45, name:"Joao Fonseca"},
      {rank:46, name:"Lorenzo Sonego"},{rank:47, name:"Roberto Bautista Agut"},{rank:48, name:"Zizou Bergs"},
      {rank:49, name:"Gael Monfils"},{rank:50, name:"Learner Tien"},{rank:51, name:"Benjamin Bonzi"},
      {rank:52, name:"Matteo Berrettini"},{rank:53, name:"Fabian Marozsan"},{rank:54, name:"Francisco Comesana"},
      {rank:55, name:"Marcos Giron"},{rank:56, name:"Daniel Altmaier"},{rank:57, name:"Hamad Medjedovic"},
      {rank:58, name:"Jordan Thompson"},{rank:59, name:"Tomas Martin Etcheverry"},{rank:60, name:"Jacob Fearnley"},
      {rank:61, name:"Damir Dzumhur"},{rank:62, name:"Marin Cilic"},{rank:63, name:"Marton Fucsovics"},
      {rank:64, name:"Matteo Arnaldi"},{rank:65, name:"Mattia Bellucci"},{rank:66, name:"Pedro Martinez"},
      {rank:67, name:"Reilly Opelka"},{rank:68, name:"Hubert Hurkacz"},{rank:69, name:"Terence Atmane"},
      {rank:70, name:"Quentin Halys"},{rank:71, name:"Aleksandar Kovacevic"},{rank:72, name:"Laslo Djere"},
      {rank:73, name:"Botic van de Zandschulp"},{rank:74, name:"Yunchaokete Bu"},{rank:75, name:"Sebastian Korda"},
      {rank:76, name:"Kamil Majchrzak"},{rank:77, name:"Adrian Mannarino"},{rank:78, name:"Mariano Navone"},
      {rank:79, name:"Arthur Cazaux"},{rank:80, name:"David Goffin"},{rank:81, name:"Christopher O'Connell"},
      {rank:82, name:"Arthur Rinderknech"},{rank:83, name:"Jesper de Jong"},{rank:84, name:"Ethan Quinn"},
      {rank:85, name:"Adam Walton"},{rank:86, name:"Luca Nardi"},{rank:87, name:"Roberto Carballes Baena"},
      {rank:88, name:"Juan Manuel Cerundolo"},{rank:89, name:"Vit Kopriva"},{rank:90, name:"Kei Nishikori"},
      {rank:91, name:"Alexander Shevchenko"},{rank:92, name:"Jenson Brooksby"},{rank:93, name:"Filip Misolic"},
      {rank:94, name:"Roman Safiullin"},{rank:95, name:"Aleksandar Vukic"},{rank:96, name:"Tristan Schoolkate"},
      {rank:97, name:"Dalibor Svrcina"},{rank:98, name:"Valentin Royer"},{rank:99, name:"Carlos Taberner"},
      {rank:100, name:"Mackenzie McDonald"}
    ];

    // ===== STATE =====
    let budget = MAX_BUDGET;
    const picks = JSON.parse(localStorage.getItem(STORAGE_KEY_PICKS) || '{"A":[],"B":[],"C":[],"D":[]}');
    let teams = JSON.parse(localStorage.getItem(STORAGE_KEY_TEAMS) || '{"teams":{}}');
    let leagues = JSON.parse(localStorage.getItem(STORAGE_KEY_LEAGUES) || '{"leagues":{}}');
    let adminEnabled = JSON.parse(localStorage.getItem(STORAGE_KEY_ADMIN) || 'false');
    let myTeamName = localStorage.getItem(STORAGE_KEY_MYNAME) || '';

    // ===== ELEMENTS =====
    const $drawer = document.getElementById('drawer');
    const $openDrawer = document.getElementById('openDrawer');
    const $closeDrawer = document.getElementById('closeDrawer');
    const $drawerBackdrop = document.getElementById('drawerBackdrop');
    const $checkUpdateBtn = document.getElementById('checkUpdateBtn');

    const $grid = document.getElementById('grid');
    const $status = document.getElementById('status');
    const $toast = document.getElementById('toast');
    const $cntA = document.getElementById('cntA');
    const $cntB = document.getElementById('cntB');
    const $cntC = document.getElementById('cntC');
    const $cntD = document.getElementById('cntD');
    const $bandFilter = document.getElementById('bandFilter');
    const $budget = document.getElementById('budget');
    const $teamName = document.getElementById('teamName');
    const $saveTeamBtn = document.getElementById('saveTeamBtn');
    const $adminBtn = document.getElementById('adminBtn');

    const $teamsList = document.getElementById('teamsList');
    const $exportTeamsBtn = document.getElementById('exportTeamsBtn');
    const $importTeamsBtn = document.getElementById('importTeamsBtn');
    const $importArea = document.getElementById('importArea');
    const $importTextarea = document.getElementById('importTextarea');
    const $confirmImportBtn = document.getElementById('confirmImportBtn');
    const $cancelImportBtn = document.getElementById('cancelImportBtn');

    const $leaguesList = document.getElementById('leaguesList');
    const $joinCode = document.getElementById('joinCode');
    const $joinLeagueBtn = document.getElementById('joinLeagueBtn');
    const $leagueName = document.getElementById('leagueName');
    const $createLeagueBtn = document.getElementById('createLeagueBtn');

    // ===== UTILS =====
    function showToast(msg){
      $toast.textContent = msg;
      $toast.classList.remove('hide');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> $toast.classList.add('hide'), 2600);
    }
    function bandFor(rank){ if (rank<=10) return 'A'; if (rank<=30) return 'B'; if (rank<=50) return 'C'; return 'D'; }
    function costFor(rank){ return (101 - rank) * 1_000_000; }
    function formatM(n){ return (n/1_000_000) + 'M'; }
    function escapeHTML(s){ return s.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }
    function isSelected(id){ return Object.values(picks).some(arr => arr.includes(id)); }
    function calcSpentFromPicks(p){ return Object.values(p).flat().map(id => parseInt(id.split('|')[0],10)).map(costFor).reduce((a,b)=>a+b, 0); }
    function calcSpent(){ return calcSpentFromPicks(picks); }
    function updateBudget(){ const spent = calcSpent(); budget = MAX_BUDGET - spent; if ($budget) $budget.textContent = formatM(budget); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function idNow(){ return Math.random().toString(36).slice(2,10); }

    // ===== DRAWER =====
    function openDrawer(){ $drawer.classList.add('open'); $drawer.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ $drawer.classList.remove('open'); $drawer.setAttribute('aria-hidden','true'); }
    $openDrawer.addEventListener('click', openDrawer);
    $closeDrawer.addEventListener('click', closeDrawer);
    $drawerBackdrop.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeDrawer(); });

    // ===== VIEW SWITCHING =====
    function switchView(view){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const target = document.getElementById(`view-${view}`);
      if (target) target.classList.add('active');
      if (view==='myteam'){ renderFiltered(); updateCounters(); }
      if (view==='teams'){ renderTeamsList(); }
      if (view==='leagues'){ renderLeaguesList(); }
      if (view==='stats'){ renderLeaderboard(); }
      closeDrawer();
    }

    // Wire menu buttons
    document.querySelectorAll('.panel .navbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (btn.id === 'checkUpdateBtn'){ hardUpdate('manual'); return; }
        const view = btn.getAttribute('data-view');
        if (view) switchView(view);
      });
    });

    // ===== MY TEAM =====
    function updateCounters(){
      if ($cntA){ $cntA.textContent = `${picks.A.length}/${MAX_PER_BAND}`; }
      if ($cntB){ $cntB.textContent = `${picks.B.length}/${MAX_PER_BAND}`; }
      if ($cntC){ $cntC.textContent = `${picks.C.length}/${MAX_PER_BAND}`; }
      if ($cntD){ $cntD.textContent = `${picks.D.length}/${MAX_PER_BAND}`; }
      localStorage.setItem(STORAGE_KEY_PICKS, JSON.stringify(picks));
      updateBudget();
      renderSelected();
      updateStatus();
    }
    function currentFilteredPlayers(){ const v = ($bandFilter && $bandFilter.value) || 'all'; return v==='all'? PLAYERS : PLAYERS.filter(p => bandFor(p.rank)===v); }

    function renderSelected(){
      const wrap = document.getElementById('selected');
      if (!wrap) return;
      wrap.innerHTML = '';
      const allSel = Object.values(picks).flat();
      if (!allSel.length){ const d=document.createElement('div'); d.className='sub'; d.textContent='No picks yet. Click players below to add them to your squad.'; wrap.appendChild(d); return; }
      const data = allSel.map(id => { const [r,name]=id.split('|'); return {rank:+r, name}; }).sort((a,b)=>a.rank-b.rank);
      for (const p of data){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div class="rank">${p.rank}</div>
          <div style="flex:1;min-width:0"><div class="name">${escapeHTML(p.name)}</div>
          <div class="meta">Cost ${formatM(costFor(p.rank))} ‚Ä¢ Band ${bandFor(p.rank)}</div></div>`;
        wrap.appendChild(card);
      }
    }

    function render(players){
      const grid = document.getElementById('grid');
      if (!grid) return;
      grid.setAttribute('aria-busy','true');
      grid.innerHTML = '';
      for (const p of players){
        const band = bandFor(p.rank);
        const id = `${p.rank}|${p.name}`;
        const selected = isSelected(id);
        const card = document.createElement('button');
        card.type='button'; card.className='card' + (selected?' sel':'');
        card.dataset.id=id; card.dataset.band=band; card.dataset.rank=String(p.rank);
        card.setAttribute('aria-pressed', selected ? 'true' : 'false');
        card.title = selected ? 'Click to remove from picks' : 'Click to add to picks';
        card.innerHTML = `<div class="rank">${p.rank}</div>
          <div style="flex:1;min-width:0"><div class="name">${escapeHTML(p.name)}</div>
          <div class="meta">Cost ${formatM(costFor(p.rank))}</div></div>
          <div class="tag ${band}" aria-hidden="true">${band}</div>`;
        grid.appendChild(card);
      }
      grid.setAttribute('aria-busy','false');
      updateStatus();
    }

    function updateStatus(){
      const status = document.getElementById('status');
      if (!status) return;
      const v = ($bandFilter && $bandFilter.value) || 'all';
      const map = {all:'All',A:'Band A (1‚Äì10)',B:'Band B (11‚Äì30)',C:'Band C (31‚Äì50)',D:'Band D (51‚Äì100)'};
      status.textContent = `Showing ${currentFilteredPlayers().length} players ‚Ä¢ Filter: ${map[v]} ‚Ä¢ Budget left: ${formatM(budget)}. Click a player to add/remove (max ${MAX_PER_BAND} per band).`;
    }

    function renderFiltered(){ render(currentFilteredPlayers()); }

    if ($bandFilter) $bandFilter.addEventListener('change', renderFiltered);

    if ($grid) $grid.addEventListener('click', (e) => {
      const btn = e.target.closest('button.card'); if (!btn) return;
      const id = btn.dataset.id; const band = btn.dataset.band; const rank = +btn.dataset.rank; const cost = costFor(rank);
      if (isSelected(id)){ picks[band] = picks[band].filter(x => x !== id); showToast('Removed from picks.'); }
      else{
        if (picks[band].length >= MAX_PER_BAND){ showToast(`Band ${band} is full (max ${MAX_PER_BAND}).`); return; }
        if (budget - cost < 0){ showToast('Not enough budget for this player.'); return; }
        picks[band].push(id); showToast('Added to picks!');
      }
      updateCounters(); renderFiltered();
    });

    const $clearBtn = document.getElementById('clearBtn');
    if ($clearBtn) $clearBtn.addEventListener('click', ()=>{ if (!Object.values(picks).some(a=>a.length)) return; picks.A=[];picks.B=[];picks.C=[];picks.D=[]; updateCounters(); renderFiltered(); showToast('All selections cleared.'); });

    const $copyBtn = document.getElementById('copyBtn');
    if ($copyBtn) $copyBtn.addEventListener('click', async ()=>{
      const spent = calcSpent(); const left = MAX_BUDGET - spent;
      function lineFor(b){ const label={A:'A (1‚Äì10)',B:'B (11‚Äì30)',C:'C (31‚Äì50)',D:'D (51‚Äì100)'}[b];
        if (!picks[b].length) return `${label}: ‚Äî`;
        const parts = picks[b].map(id => { const [r,n]=id.split('|'); return `${r} ${n} (${formatM(costFor(+r))})`; }).join(', ');
        return `${label}: ${parts}`;
      }
      const text = ['FantaTennis ‚Äî My Picks (ATP snapshot Aug 25, 2025)', lineFor('A'), lineFor('B'), lineFor('C'), lineFor('D'), `Total spent: ${formatM(spent)}`, `Budget left: ${formatM(left)}`].join('\n');
      try{ await navigator.clipboard.writeText(text); showToast('Picks copied to clipboard.'); }
      catch{ showToast('Copy failed.'); }
    });

    // ===== TEAMS / RESULTS =====
    function ensureTeamsShape(){ if (!teams || typeof teams!=='object' || !teams.teams) teams={teams:{}}; }
    function saveTeams(){ ensureTeamsShape(); localStorage.setItem(STORAGE_KEY_TEAMS, JSON.stringify(teams)); }
    function upsertTeam(name, obj){ ensureTeamsShape(); teams.teams[name]=obj; saveTeams(); }
    function teamExists(name){ return !!(teams.teams && teams.teams[name]); }
    function buildTeamFromCurrent(name){ return { name, picks: JSON.parse(JSON.stringify(picks)), createdAt:new Date().toISOString(), updatedAt:new Date().toISOString(), results: teams.teams[name]?.results || [] }; }
    function getTotalPoints(team){ return (team.results||[]).reduce((a,r)=> a + (Number(r.points)||0), 0); }

    if ($saveTeamBtn) $saveTeamBtn.addEventListener('click', ()=>{
      const name = ($teamName.value||'').trim(); if (!name){ showToast('Enter a team name.'); return; }
      if (teamExists(name) && !confirm('Team exists. Update with current picks?')) return;
      const team = buildTeamFromCurrent(name); upsertTeam(name, team); myTeamName=name; localStorage.setItem(STORAGE_KEY_MYNAME, myTeamName);
      renderTeamsList(); renderLeaderboard(); renderLeaguesList(); showToast('Team saved.');
    });

    if ($exportTeamsBtn) $exportTeamsBtn.addEventListener('click', async ()=>{ const payload=JSON.stringify(teams,null,2); try{ await navigator.clipboard.writeText(payload); showToast('Teams JSON copied.'); }catch{ showToast('Copy failed.'); }});
    if ($importTeamsBtn) $importTeamsBtn.addEventListener('click', ()=>{ $importArea.classList.remove('hide'); });
    if ($cancelImportBtn) $cancelImportBtn.addEventListener('click', ()=>{ $importArea.classList.add('hide'); $importTextarea.value=''; });
    if ($confirmImportBtn) $confirmImportBtn.addEventListener('click', ()=>{
      let obj; try{ obj = JSON.parse($importTextarea.value); }catch{ showToast('Invalid JSON.'); return; }
      if (!obj || typeof obj!=='object' || !obj.teams){ showToast('JSON must be {"teams":{...}}'); return; }
      let added=0, skipped=0; ensureTeamsShape();
      for (const [name, team] of Object.entries(obj.teams)){ if (teams.teams[name]){ skipped++; continue; }
        team.name=name; team.results=Array.isArray(team.results)?team.results:[]; teams.teams[name]=team; added++; }
      saveTeams(); renderTeamsList(); renderLeaderboard(); renderLeaguesList();
      showToast(`Import: ${added} added, ${skipped} skipped.`); $importArea.classList.add('hide'); $importTextarea.value='';
    });

    // Admin
    function updateAdminUI(){ const b=document.getElementById('adminBtn'); if (b) b.textContent = adminEnabled ? '‚úÖ Admin ON' : 'üîí Admin mode'; renderTeamsList(); renderLeaguesList(); }
    if ($adminBtn) $adminBtn.addEventListener('click', ()=>{
      if (adminEnabled){ adminEnabled=false; localStorage.setItem(STORAGE_KEY_ADMIN,'false'); updateAdminUI(); showToast('Admin disabled.'); return; }
      const pin = prompt('Enter admin PIN'); if (pin===ADMIN_PIN){ adminEnabled=true; localStorage.setItem(STORAGE_KEY_ADMIN,'true'); updateAdminUI(); showToast('Admin enabled.'); } else showToast('Incorrect PIN.');
    });

    // Teams list
    function renderTeamsList(){
      ensureTeamsShape();
      const container = $teamsList; if (!container) return;
      const all = Object.values(teams.teams); container.innerHTML='';
      if (!all.length){ const p=document.createElement('p'); p.className='sub'; p.textContent='No teams yet.'; container.appendChild(p); return; }
      all.sort((a,b)=> getTotalPoints(b)-getTotalPoints(a) || a.name.localeCompare(b.name));
      for (const t of all){
        const wrap=document.createElement('div'); wrap.className='card'; wrap.style.flexDirection='column'; wrap.style.alignItems='stretch';
        const head=document.createElement('div'); head.className='row'; head.style.justifyContent='space-between';
        head.innerHTML = `<div style="font-weight:800">${escapeHTML(t.name)}</div><div class="sub">Points: <b>${getTotalPoints(t)}</b> ‚Ä¢ Spent: <b>${formatM(calcSpentFromPicks(t.picks))}</b></div>`;
        const picksDiv=document.createElement('div'); picksDiv.className='sub';
        function fmtBand(b){ const label={A:'A',B:'B',C:'C',D:'D'}[b]; const list=(t.picks[b]||[]).map(id=>id.split('|')[1]).join(', ')||'‚Äî'; return `<span><b>${label}:</b> ${escapeHTML(list)}</span>`; }
        picksDiv.innerHTML = `<div class="row" style="gap:14px">${fmtBand('A')} ${fmtBand('B')} ${fmtBand('C')} ${fmtBand('D')}</div>`;
        const table=document.createElement('table'); table.className='table';
        const rows=(t.results||[]).slice().sort((a,b)=> (b.date||'').localeCompare(a.date||'')); 
        table.innerHTML = `<thead><tr><th style="width:40%">Tournament</th><th style="width:20%">Date</th><th style="width:20%">Points</th><th style="width:20%"></th></tr></thead>
          <tbody>${rows.map(r=>`<tr data-id="${r.id}"><td>${escapeHTML(r.tournament||'')}</td><td>${escapeHTML(r.date||'')}</td><td>${Number(r.points)||0}</td><td>${adminEnabled?`<button data-action="del" data-team="${encodeURIComponent(t.name)}" data-res="${r.id}">Delete</button>`:''}</td></tr>`).join('')}
          ${rows.length? '' : `<tr><td colspan="4" class="sub">No results yet.</td></tr>`}</tbody>`;
        const form=document.createElement('div'); form.className='row'; form.style.marginTop='8px';
        form.innerHTML = `<input type="text" placeholder="Tournament name" data-field="tournament" ${!adminEnabled?'disabled':''} />
          <input type="number" placeholder="Points" data-field="points" min="0" step="1" ${!adminEnabled?'disabled':''} />
          <input type="date" data-field="date" value="${todayISO()}" ${!adminEnabled?'disabled':''} />
          <button data-action="addResult" data-team="${encodeURIComponent(t.name)}" ${!adminEnabled?'disabled':''}>Add Result</button> ${!adminEnabled?'<span class="sub">Admin mode required</span>':''}`;
        wrap.appendChild(head); wrap.appendChild(picksDiv); wrap.appendChild(table); wrap.appendChild(form); container.appendChild(wrap);
      }
      container.querySelectorAll('button[data-action="del"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if (!adminEnabled){ showToast('Admin only.'); return; }
          const teamName=decodeURIComponent(btn.getAttribute('data-team')); const resId=btn.getAttribute('data-res');
          const team=teams.teams[teamName]; if (!team) return;
          team.results=(team.results||[]).filter(r=>r.id!==resId); team.updatedAt=new Date().toISOString(); upsertTeam(teamName, team);
          renderTeamsList(); renderLeaderboard(); renderLeaguesList(); showToast('Result removed.');
        });
      });
      container.querySelectorAll('button[data-action="addResult"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if (!adminEnabled){ showToast('Admin only.'); return; }
          const card=btn.closest('.card'); const teamName=decodeURIComponent(btn.getAttribute('data-team')); const team=teams.teams[teamName];
          const tournament=card.querySelector('input[data-field="tournament"]').value.trim();
          const points=Number(card.querySelector('input[data-field="points"]').value);
          const date=card.querySelector('input[data-field="date"]').value || todayISO();
          if (!tournament){ showToast('Tournament name required.'); return; }
          if (isNaN(points)){ showToast('Points must be a number.'); return; }
          team.results=team.results||[]; team.results.push({id:idNow(), tournament, points, date}); team.updatedAt=new Date().toISOString();
          upsertTeam(teamName, team); renderTeamsList(); renderLeaderboard(); renderLeaguesList(); showToast('Result added.');
        });
      });
    }

    // Leagues
    function ensureLeaguesShape(){ if (!leagues || typeof leagues!=='object' || !leagues.leagues) leagues={leagues:{}}; }
    function saveLeagues(){ ensureLeaguesShape(); localStorage.setItem(STORAGE_KEY_LEAGUES, JSON.stringify(leagues)); }
    function createLeague(name){ const id=idNow(); const inviteCode=Math.random().toString(36).slice(2,8).toUpperCase(); leagues.leagues[id]={id,name,inviteCode,createdAt:new Date().toISOString(),members:[]}; saveLeagues(); return leagues.leagues[id]; }
    function findLeagueByCode(code){ ensureLeaguesShape(); code=(code||'').trim().toUpperCase(); return Object.values(leagues.leagues).find(l => l.inviteCode.toUpperCase()===code); }
    function renderLeaguesList(){
      ensureLeaguesShape(); const container=$leaguesList; if (!container) return; container.innerHTML='';
      const all=Object.values(leagues.leagues); if (!all.length){ const p=document.createElement('p'); p.className='sub'; p.textContent='No leagues yet.'; container.appendChild(p); return; }
      all.sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
      for (const L of all){
        const wrap=document.createElement('div'); wrap.className='card'; wrap.style.flexDirection='column'; wrap.style.alignItems='stretch';
        const memberTeams=(L.members||[]).map(n=>teams.teams[n]).filter(Boolean).sort((a,b)=> getTotalPoints(b)-getTotalPoints(a) || a.name.localeCompare(b.name));
        const table=`<table class="table"><thead><tr><th style="width:5%">#</th><th style="width:45%">Team</th><th style="width:25%">Total Points</th><th style="width:25%">Spent</th></tr></thead>
          <tbody>${memberTeams.map((t,i)=>`<tr><td>${i+1}</td><td>${escapeHTML(t.name)}</td><td>${getTotalPoints(t)}</td><td>${formatM(calcSpentFromPicks(t.picks))}</td></tr>`).join('')}
          ${memberTeams.length? '' : `<tr><td colspan="4" class="sub">No members yet.</td></tr>`}</tbody></table>`;
        wrap.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center">
            <div><div style="font-weight:800">${escapeHTML(L.name)}</div><div class="sub">Invite code: <code class="kbd">${L.inviteCode}</code></div></div>
            <div class="row"><button data-action="copyCode" data-code="${L.inviteCode}">Copy code</button>${adminEnabled?`<button data-action="deleteLeague" data-id="${L.id}">Delete</button>`:''}</div>
          </div><div style="margin-top:8px">${table}</div>`;
        container.appendChild(wrap);
      }
      container.querySelectorAll('button[data-action="copyCode"]').forEach(b=> b.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(b.dataset.code); showToast('Invite code copied.'); }catch{ showToast('Copy failed.'); }}));
      container.querySelectorAll('button[data-action="deleteLeague"]').forEach(b=> b.addEventListener('click', ()=>{ if (!adminEnabled){ showToast('Admin only.'); return; } const id=b.dataset.id; if(!confirm('Delete this league?')) return; delete leagues.leagues[id]; saveLeagues(); renderLeaguesList(); showToast('League deleted.'); }));
    }
    if ($createLeagueBtn) $createLeagueBtn.addEventListener('click', ()=>{ if (!adminEnabled){ showToast('Admin only.'); return; } const name=($leagueName.value||'').trim(); if(!name){ showToast('League name required.'); return; } const L=createLeague(name); $leagueName.value=''; renderLeaguesList(); showToast(`League created. Code: ${L.inviteCode}`); });
    if ($joinLeagueBtn) $joinLeagueBtn.addEventListener('click', ()=>{ const code=($joinCode.value||'').trim().toUpperCase(); if(!code){ showToast('Enter invite code.'); return; } if(!myTeamName || !teams.teams[myTeamName]){ showToast('Save your team first.'); return; } const L=findLeagueByCode(code); if(!L){ showToast('League not found.'); return; } if (!L.members) L.members=[]; if (L.members.includes(myTeamName)){ showToast('Team already in league.'); return; } L.members.push(myTeamName); saveLeagues(); $joinCode.value=''; renderLeaguesList(); showToast('Joined league!'); });

    // Stats
    function renderLeaderboard(){
      const tbody=document.querySelector('#leaderboard tbody'); if (!tbody) return; tbody.innerHTML='';
      const all=Object.values(teams.teams||{}); if (!all.length){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4" class="sub">No teams yet.</td>'; tbody.appendChild(tr); return; }
      all.sort((a,b)=> getTotalPoints(b)-getTotalPoints(a) || a.name.localeCompare(b.name));
      all.forEach((t,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${escapeHTML(t.name)}</td><td>${getTotalPoints(t)}</td><td>${formatM(calcSpentFromPicks(t.picks))}</td>`; tbody.appendChild(tr); });
    }

    // Init
    function ensureLeaguesInit(){ if (!leagues || typeof leagues!=='object' || !leagues.leagues) leagues={leagues:{}}; }
    ensureLeaguesInit();
    if (!Object.keys(leagues.leagues).length){ createLeague('Global League'); }
    if (myTeamName) { const el=document.getElementById('teamName'); if (el) el.value=myTeamName; }
    (function initAdmin(){ const b=document.getElementById('adminBtn'); if (b) b.textContent = adminEnabled ? '‚úÖ Admin ON' : 'üîí Admin mode'; })();
    updateBudget();
    switchView('home'); // start on Home; menu switches views fully now
  </script>
</body>
</html>
